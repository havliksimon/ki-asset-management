{% extends "blog/base_blog.html" %}

{% block title %}{% if post %}Edit: {{ post.title }}{% else %}New Blog Post{% endif %} | KI Asset Management Blog{% endblock %}

{% block content %}
<!-- Editor Header -->
<section class="blog-hero">
    <div class="container">
        <h1>{% if post %}Edit Post{% else %}New Blog Post{% endif %}</h1>
        <p>Share your investment insights with the KI Asset Management community.</p>
    </div>
</section>

<!-- AI Document Import Section (Only for new posts) -->
{% if not post %}
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-magic"></i> AI-Powered Document Import</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload a PDF or DOCX file (e.g., stock analysis, research paper) and let AI transform it into a complete, SEO-optimized blog article.
                </p>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Document File</label>
                        <input type="file" class="form-control" id="documentUpload" 
                               accept=".pdf,.docx,.doc" onchange="handleDocumentSelect(this)">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Target Style</label>
                        <select class="form-select" id="documentStyle">
                            <option value="seo_article">SEO Article</option>
                            <option value="investment_pitch">Investment Pitch (Stock Analysis)</option>
                            <option value="academic_paper">Academic Paper</option>
                            <option value="blog_post">Blog Post</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary w-100" id="generateFromDocBtn" 
                                onclick="generateFromDocument()" disabled>
                            <i class="bi bi-stars"></i> Generate Article
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearDocumentImport()">
                            <i class="bi bi-x-lg"></i> Clear
                        </button>
                    </div>
                </div>
                <div id="documentProgress" class="mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span id="documentProgressText">Processing document...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- PDF Blog Post Section -->
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> PDF Research Report</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload a PDF research report to display it directly on the blog page. 
                    Perfect for presenting in-depth analysis, whitepapers, or investment theses.
                </p>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">PDF File</label>
                        <input type="file" class="form-control" id="pdfUpload" accept=".pdf" onchange="handlePdfSelect(this)">
                        <div class="form-text">Max 25MB. Research reports, whitepapers, etc.</div>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-success w-100" id="uploadPdfBtn" onclick="uploadPdf()" disabled>
                            <i class="bi bi-cloud-upload"></i> Upload PDF
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearPdfUpload()">
                            <i class="bi bi-x-lg"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Upload progress -->
                <div id="pdfProgress" class="mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                        <span id="pdfProgressText">Uploading PDF...</span>
                    </div>
                </div>
                
                <!-- Uploaded PDF info -->
                <div id="pdfInfo" class="mt-3 d-none">
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <div>
                            <strong>PDF uploaded:</strong> <span id="pdfFilename"></span>
                            <span class="text-muted ms-2" id="pdfFileSize"></span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="deletePdf()">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                    <input type="hidden" name="pdf_path" id="pdfPath" value="{{ post.pdf_path if post and post.pdf_path else '' }}">
                </div>
                
                <!-- Show existing PDF for edit mode -->
                {% if post and post.pdf_path %}
                <div id="existingPdfInfo" class="mt-3">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="bi bi-file-earmark-pdf-fill me-2"></i>
                        <div>
                            <strong>Current PDF:</strong> {{ post.pdf_filename }}
                            <a href="{{ url_for('static', filename=post.pdf_path) }}" target="_blank" class="ms-2 btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="deleteExistingPdf({{ post.id }})">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                    <input type="hidden" name="pdf_path" id="pdfPath" value="{{ post.pdf_path }}">
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<div class="container mb-5">
    <form method="POST" action="{% if post %}{{ url_for('blog.edit_post', post_id=post.id) }}{% else %}{{ url_for('blog.new_post') }}{% endif %}" id="blogForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="row">
            <!-- Main Editor -->
            <div class="col-lg-8">
                <div class="blog-editor">
                    <div class="blog-editor-header">
                        <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Content</h5>
                    </div>
                    <div class="blog-editor-body">
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">Title *</label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                   value="{{ post.title if post else '' }}" required
                                   placeholder="Enter an engaging title...">
                            <div class="form-text">Make it catchy and descriptive. Max 255 characters.</div>
                        </div>
                        
                        <!-- Content -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">Content *</label>
                            
                            <!-- Editor Toolbar -->
                            <div class="editor-toolbar">
                                <button type="button" onclick="insertTag('<h2>', '</h2>')" title="Heading">
                                    <i class="bi bi-type-h1"></i>
                                </button>
                                <button type="button" onclick="insertTag('<p>', '</p>')" title="Paragraph">
                                    <i class="bi bi-paragraph"></i>
                                </button>
                                <button type="button" onclick="insertTag('<strong>', '</strong>')" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" onclick="insertTag('<em>', '</em>')" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" onclick="insertTag('<blockquote>', '</blockquote>')" title="Quote">
                                    <i class="bi bi-quote"></i>
                                </button>
                                <button type="button" onclick="insertTag('<ul>\\n  <li>', '</li>\\n</ul>')" title="List">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" onclick="insertTag('<a href=\"\">', '</a>')" title="Link">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <button type="button" onclick="insertTag('<img src=\"\" alt=\"\">', '')" title="Image">
                                    <i class="bi bi-image"></i>
                                </button>
                                <button type="button" onclick="document.getElementById('imageUpload').click()" title="Upload Image">
                                    <i class="bi bi-cloud-upload"></i>
                                </button>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                            </div>
                            
                            <!-- Content Textarea -->
                            <textarea class="editor-content" id="content" name="content" required
                                      placeholder="Write your article here... Use HTML formatting or Markdown.">{{ post.content if post else '' }}</textarea>
                            
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="form-text">
                                    Supports HTML formatting. Use the toolbar above or write HTML directly.
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="showTranslateModal()">
                                    <i class="bi bi-translate"></i> Translate to English
                                </button>
                            </div>
                        </div>
                        
                        <!-- Excerpt -->
                        <div class="mb-4">
                            <label for="excerpt" class="form-label fw-bold">Excerpt</label>
                            <textarea class="form-control" id="excerpt" name="excerpt" rows="3"
                                      placeholder="Brief summary for previews (optional)...">{{ post.excerpt if post else '' }}</textarea>
                            <div class="form-text">A short summary that appears in previews. If left empty, we'll generate one from your content.</div>
                        </div>
                    </div>
                </div>
                
                <!-- SEO Settings -->
                <div class="blog-editor mt-4">
                    <div class="blog-editor-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-search"></i> SEO Settings</h5>
                        <button type="button" class="btn btn-sm btn-primary" onclick="autoGenerateSEO()">
                            <i class="bi bi-magic"></i> Auto-Generate with AI
                        </button>
                    </div>
                    <div class="blog-editor-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="meta_description" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="meta_description" name="meta_description" rows="3"
                                          placeholder="Description for search engines...">{{ post.meta_description if post else '' }}</textarea>
                                <div class="form-text">Max 300 characters. Shown in search results.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="meta_keywords" class="form-label">Meta Keywords</label>
                                <input type="text" class="form-control" id="meta_keywords" name="meta_keywords"
                                       value="{{ post.meta_keywords if post else '' }}"
                                       placeholder="investment, analysis, stocks...">
                                <div class="form-text">Comma-separated keywords.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="og_image" class="form-label">Featured Image URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="og_image" name="og_image"
                                       value="{{ post.og_image if post else '' }}"
                                       placeholder="https://example.com/image.jpg">
                                <button type="button" class="btn btn-outline-primary" onclick="searchUnsplashImage()">
                                    <i class="bi bi-image"></i> Auto-Find Image
                                </button>
                            </div>
                            <div class="form-text">URL to featured image for social sharing. Recommended: 1200x630px.</div>
                        </div>
                        
                        <!-- Manual Image Search -->
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label fw-bold"><i class="bi bi-search"></i> Manual Image Search</label>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="manualSearchQuery" 
                                           placeholder="Enter keywords (e.g., 'stock market', 'technology', 'office')...">
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchUnsplashManual()">
                                        <i class="bi bi-search"></i> Search Images
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                If auto-search doesn't find images, try searching with a single keyword like 
                                <code>business</code>, <code>technology</code>, <code>finance</code>, <code>charts</code>, 
                                <code>office</code>, or <code>city</code>.
                            </div>
                        </div>
                        
                        <div id="unsplashPreview" class="mt-3 d-none">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Choose a Featured Image:</label>
                                <span id="unsplashCount" class="badge bg-secondary"></span>
                            </div>
                            <div id="unsplashGallery" class="row g-2">
                                <!-- Images will be inserted here -->
                            </div>
                            <div id="unsplashNoResults" class="alert alert-warning d-none mt-3">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>No images found.</strong> Try searching with simpler keywords like 
                                <a href="javascript:void(0)" onclick="quickSearch('business')">business</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('technology')">technology</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('finance')">finance</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('office')">office</a>, or
                                <a href="javascript:void(0)" onclick="quickSearch('charts')">charts</a>.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Settings -->
            <div class="col-lg-4">
                <!-- Publish Settings -->
                <div class="blog-sidebar-card sticky-top" style="top: 100px;">
                    <h4><i class="bi bi-gear"></i> Post Settings</h4>
                    
                    <!-- Status -->
                    {% if post %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Status</label>
                        <div class="d-flex align-items-center gap-2">
                            {% if post.status == 'published' %}
                            <span class="status-badge published">
                                <i class="bi bi-check-circle"></i> Published
                            </span>
                            {% else %}
                            <span class="status-badge draft">
                                <i class="bi bi-pencil"></i> Draft
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Publish Date Editor (Admin or Published posts) -->
                        {% if current_user.is_admin or post.status == 'published' %}
                        <div class="mt-2">
                            <label for="publish_date" class="form-label small text-muted">Publish Date</label>
                            <input type="datetime-local" class="form-control form-control-sm" id="publish_date" name="publish_date"
                                   value="{{ post.published_at.strftime('%Y-%m-%dT%H:%M') if post.published_at else '' }}">
                            <div class="form-text small">Change when this post appears as published.</div>
                            
                            <!-- Auto-date tool based on analysis -->
                            <div class="mt-2 p-2 bg-light rounded">
                                <label class="form-label small text-muted">
                                    <i class="bi bi-calendar-check"></i> Auto-fill from Analysis
                                </label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="analysisSearchTerm" 
                                           placeholder="Enter company name or ticker...">
                                    <button type="button" class="btn btn-outline-secondary" onclick="findAnalysisDate()">
                                        <i class="bi bi-search"></i> Find
                                    </button>
                                </div>
                                <div class="form-text small">Search by company name/ticker to find analysis date.</div>
                                <div id="analysisDateResults" class="mt-2 d-none">
                                    <!-- Results will appear here -->
                                </div>
                            </div>
                        </div>
                        {% elif post.published_at %}
                        <div class="form-text mt-1">
                            Published: {{ post.published_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        {% else %}
                        <div class="form-text mt-1">
                            Not published yet
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label fw-bold">Category</label>
                        <input type="text" class="form-control" id="category" name="category"
                               value="{{ post.category if post else '' }}"
                               list="categoryList" placeholder="Select or type new...">
                        <datalist id="categoryList">
                            {% for category in categories %}
                            <option value="{{ category }}">
                            {% endfor %}
                            <option value="Market Analysis">
                            <option value="Investment Strategy">
                            <option value="Company Research">
                            <option value="Education">
                            <option value="News">
                        </datalist>
                    </div>
                    
                    <!-- Tags -->
                    <div class="mb-3">
                        <label for="tags" class="form-label fw-bold">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags"
                               value="{{ post.tags if post else '' }}"
                               placeholder="stocks, emerging-markets, value...">
                        <div class="form-text">Comma-separated tags.</div>
                    </div>
                    
                    <!-- Visibility -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_public" name="is_public" 
                                   {% if post %}{{ 'checked' if post.is_public else '' }}{% endif %}>
                            <label class="form-check-label fw-bold" for="is_public">
                                <i class="bi bi-globe"></i> Public
                            </label>
                        </div>
                        <div class="form-text">Make this post visible to everyone.</div>
                    </div>
                    
                    <!-- Featured (Admin only) -->
                    {% if current_user.is_admin %}
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                                   {% if post %}{{ 'checked' if post.is_featured else '' }}{% endif %}>
                            <label class="form-check-label fw-bold" for="is_featured">
                                <i class="bi bi-star"></i> Featured Post
                            </label>
                        </div>
                        <div class="form-text">Show on homepage (Admin only).</div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> {% if post %}Save Changes{% else %}Save Draft{% endif %}
                        </button>
                        
                        {% if post %}
                        <a href="{{ url_for('blog.preview_post', post_id=post.id) }}" target="_blank" class="btn btn-outline-info">
                            <i class="bi bi-eye"></i> Preview
                        </a>
                        
                        {% if post.status == 'draft' %}
                        <button type="button" class="btn btn-success" onclick="document.getElementById('publishForm').submit()">
                            <i class="bi bi-check-circle"></i> Publish Now
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-warning" onclick="document.getElementById('unpublishForm').submit()">
                            <i class="bi bi-eye-slash"></i> Unpublish
                        </button>
                        {% endif %}
                        
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Back Link -->
                    <div class="mt-3 text-center">
                        <a href="{% if post %}{{ url_for('blog.post', slug=post.slug) }}{% else %}{{ url_for('blog.my_posts') }}{% endif %}" class="text-muted">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    {% if post %}
    <!-- Hidden forms for actions -->
    <form id="publishForm" action="{{ url_for('blog.publish_post', post_id=post.id) }}" method="POST" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
    <form id="unpublishForm" action="{{ url_for('blog.unpublish_post', post_id=post.id) }}" method="POST" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
    {% endif %}
</div>

<!-- Delete Modal -->
{% if post %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong>{{ post.title }}</strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('blog.delete_post', post_id=post.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Yes, Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Translate Modal -->
<div class="modal fade" id="translateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-translate"></i> Translate Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Source Language</label>
                    <select class="form-select" id="translateSourceLang">
                        <option value="auto">Auto-detect</option>
                        <option value="cs" selected>Czech</option>
                        <option value="de">German</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="it">Italian</option>
                        <option value="pl">Polish</option>
                        <option value="sk">Slovak</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Target Language</label>
                    <select class="form-select" id="translateTargetLang">
                        <option value="en" selected>English</option>
                        <option value="cs">Czech</option>
                        <option value="de">German</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="it">Italian</option>
                        <option value="pl">Polish</option>
                        <option value="sk">Slovak</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Content to Translate</label>
                    <textarea class="form-control" id="translateContent" rows="8"
                              placeholder="Enter or paste content to translate..."></textarea>
                    <div class="form-text" id="translateCharCount">0 / 10,000 characters</div>
                </div>
                <div id="translateProgress" class="d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>Translating...</span>
                    </div>
                </div>
                <div id="translateResult" class="d-none">
                    <label class="form-label fw-bold">Translated Content</label>
                    <textarea class="form-control" id="translatedContent" rows="8"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="translateBtn" onclick="performTranslation()">
                    <i class="bi bi-translate"></i> Translate
                </button>
                <button type="button" class="btn btn-success d-none" id="applyTranslateBtn" onclick="applyTranslation()">
                    <i class="bi bi-check"></i> Apply to Content
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Custom column size for 5 columns on large screens */
.col-lg-1-5 {
    flex: 0 0 auto;
    width: 20%;
}

@media (max-width: 991.98px) {
    .col-lg-1-5 {
        width: 25%;
    }
}

@media (max-width: 767.98px) {
    .col-lg-1-5 {
        width: 33.333%;
    }
}

/* Image hover effect */
.unsplash-image-option {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.unsplash-image-option:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
}

/* Object fit for images */
.object-fit-cover {
    object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// CSRF token helper - gets token from meta tag or hidden input
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content ||
           document.querySelector('input[name="csrf_token"]')?.value || '';
}
// Insert HTML tags around selection
function insertTag(openTag, closeTag) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const before = text.substring(0, start);
    const selection = text.substring(start, end);
    const after = text.substring(end);
    
    textarea.value = before + openTag + selection + closeTag + after;
    textarea.focus();
    textarea.selectionStart = start + openTag.length;
    textarea.selectionEnd = end + openTag.length;
}

// Upload image
function uploadImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('{{ url_for('blog.upload_image') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.url) {
            const textarea = document.getElementById('content');
            const imgTag = `<img src="${data.url}" alt="${file.name}" class="img-fluid rounded">\n`;
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
            alert('Image uploaded and inserted!');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to upload image. Please try again.');
    });
}

// Auto-save draft (every 30 seconds)
{% if post %}
let autoSaveInterval;
let lastContent = document.getElementById('content').value;

document.addEventListener('DOMContentLoaded', function() {
    autoSaveInterval = setInterval(function() {
        const currentContent = document.getElementById('content').value;
        if (currentContent !== lastContent) {
            // Could implement auto-save to server here
            lastContent = currentContent;
            console.log('Auto-saved draft');
        }
    }, 30000);
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    const currentContent = document.getElementById('content').value;
    if (currentContent !== lastContent) {
        e.preventDefault();
        e.returnValue = '';
    }
});
{% endif %}

// Form validation
document.getElementById('blogForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title) {
        e.preventDefault();
        alert('Please enter a title.');
        document.getElementById('title').focus();
        return false;
    }
    
    if (!content) {
        e.preventDefault();
        alert('Please enter some content.');
        document.getElementById('content').focus();
        return false;
    }
    
    return true;
});

// ============================================================================
// AI-ASSISTED FUNCTIONS
// ============================================================================

// Store current images for selection
let currentUnsplashImages = [];

// Auto-generate SEO metadata using DeepSeek AI
function autoGenerateSEO() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const category = document.getElementById('category').value.trim();
    
    if (!title || !content) {
        alert('Please enter a title and content first.');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.generate_seo_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ title, content, category })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fill in the SEO fields
            if (data.meta_description) {
                document.getElementById('meta_description').value = data.meta_description;
            }
            if (data.meta_keywords) {
                document.getElementById('meta_keywords').value = data.meta_keywords;
            }
            if (data.excerpt && !document.getElementById('excerpt').value) {
                document.getElementById('excerpt').value = data.excerpt;
            }
            if (data.suggested_tags && !document.getElementById('tags').value) {
                document.getElementById('tags').value = data.suggested_tags;
            }
            if (data.images && data.images.length > 0) {
                currentUnsplashImages = data.images;
                document.getElementById('og_image').value = data.images[0].url;
                showUnsplashGallery(data.images);
                document.getElementById('unsplashNoResults').classList.add('d-none');
            } else {
                // Show no results message with suggestions
                const previewDiv = document.getElementById('unsplashPreview');
                const gallery = document.getElementById('unsplashGallery');
                const noResultsDiv = document.getElementById('unsplashNoResults');
                const countBadge = document.getElementById('unsplashCount');
                
                gallery.innerHTML = '';
                countBadge.textContent = '0 images';
                noResultsDiv.classList.remove('d-none');
                previewDiv.classList.remove('d-none');
            }
            
            // Show success notification
            showNotification('SEO metadata generated successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to generate SEO', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error generating SEO metadata', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Search for Unsplash images (auto mode - based on title/category)
function searchUnsplashImage() {
    const title = document.getElementById('title').value.trim();
    const category = document.getElementById('category').value.trim();
    
    // Build search query from title/category
    let query = category || '';
    if (title) {
        // Extract key words from title (words longer than 4 chars)
        const words = title.match(/\b[A-Za-z]{5,}\b/g) || [];
        if (words.length > 0) {
            query = words.slice(0, 3).join(' ');
        }
    }
    
    if (!query) {
        showNotification('Please enter a title or category first, or use manual search below.', 'warning');
        document.getElementById('manualSearchQuery').focus();
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Searching...';
    btn.disabled = true;
    
    // Request up to 30 images
    performUnsplashSearch(query, 30, btn, originalText, true);
}

// Manual search for Unsplash images
function searchUnsplashManual() {
    const query = document.getElementById('manualSearchQuery').value.trim();
    
    if (!query) {
        showNotification('Please enter search keywords.', 'warning');
        document.getElementById('manualSearchQuery').focus();
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Searching...';
    btn.disabled = true;
    
    // Request up to 30 images
    performUnsplashSearch(query, 30, btn, originalText, false);
}

// Quick search from "no results" message links
function quickSearch(keyword) {
    document.getElementById('manualSearchQuery').value = keyword;
    
    // Find the manual search button and trigger click
    const btn = document.querySelector('button[onclick="searchUnsplashManual()"]');
    if (btn) {
        btn.click();
    }
}

// Perform the actual Unsplash API search
function performUnsplashSearch(query, count, btn, originalText, isAutoSearch) {
    fetch('{{ url_for('blog.search_unsplash_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ query, orientation: 'landscape', count: count })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.images && data.images.length > 0) {
            currentUnsplashImages = data.images;
            document.getElementById('og_image').value = data.images[0].url;
            showUnsplashGallery(data.images);
            
            // Hide "no results" message
            document.getElementById('unsplashNoResults').classList.add('d-none');
            
            const searchType = isAutoSearch ? 'Auto-search' : 'Search';
            showNotification(`${searchType} found ${data.images.length} images! Click one to select.`, 'success');
        } else {
            // Show gallery area but with "no results" message
            const previewDiv = document.getElementById('unsplashPreview');
            const gallery = document.getElementById('unsplashGallery');
            const noResultsDiv = document.getElementById('unsplashNoResults');
            const countBadge = document.getElementById('unsplashCount');
            
            gallery.innerHTML = '';
            countBadge.textContent = '0 images';
            noResultsDiv.classList.remove('d-none');
            previewDiv.classList.remove('d-none');
            
            if (isAutoSearch) {
                showNotification(`No images found for "${data.query || query}". Try manual search with simpler keywords.`, 'warning');
            } else {
                showNotification(`No images found for "${data.query || query}". Try different keywords.`, 'warning');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error searching for images', 'danger');
    })
    .finally(() => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}

// Show Unsplash image gallery
function showUnsplashGallery(images) {
    const previewDiv = document.getElementById('unsplashPreview');
    const gallery = document.getElementById('unsplashGallery');
    const countBadge = document.getElementById('unsplashCount');
    
    gallery.innerHTML = '';
    
    // Update count badge
    countBadge.textContent = `${images.length} image${images.length !== 1 ? 's' : ''}`;
    
    images.forEach((image, index) => {
        const col = document.createElement('div');
        // Adjust column size based on image count - more images = smaller columns
        let colClass = 'col-4 col-md-2';
        if (images.length > 12) {
            colClass = 'col-3 col-md-2 col-lg-1-5';  // Smaller for many images
        }
        col.className = colClass;
        col.innerHTML = `
            <div class="unsplash-image-option position-relative cursor-pointer rounded overflow-hidden ${index === 0 ? 'border border-3 border-primary' : 'border'}" 
                 onclick="selectUnsplashImage(${index}, this)" 
                 style="cursor: pointer; aspect-ratio: 16/10;"
                 title="${image.description || 'Image by ' + image.author_name}">
                <img src="${image.thumb_url || image.url}" 
                     alt="${image.description || 'Unsplash image'}" 
                     class="w-100 h-100 object-fit-cover"
                     loading="lazy">
                <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-1" style="font-size: 0.6rem;">
                    by ${image.author_name}
                </div>
            </div>
        `;
        gallery.appendChild(col);
    });
    
    previewDiv.classList.remove('d-none');
}

// Select a specific Unsplash image
function selectUnsplashImage(index, element) {
    if (!currentUnsplashImages[index]) return;
    
    // Update selected image
    document.getElementById('og_image').value = currentUnsplashImages[index].url;
    
    // Update visual selection
    document.querySelectorAll('.unsplash-image-option').forEach(el => {
        el.classList.remove('border-3', 'border-primary');
        el.classList.add('border');
    });
    element.classList.remove('border');
    element.classList.add('border-3', 'border-primary');
    
    showNotification('Image selected!', 'success');
}

// Document upload handling
let selectedDocument = null;

function handleDocumentSelect(input) {
    if (input.files && input.files[0]) {
        selectedDocument = input.files[0];
        document.getElementById('generateFromDocBtn').disabled = false;
        
        // Validate file size (max 10MB)
        if (selectedDocument.size > 10 * 1024 * 1024) {
            alert('File is too large. Maximum size is 10MB.');
            clearDocumentImport();
            return;
        }
    }
}

function generateFromDocument() {
    if (!selectedDocument) {
        alert('Please select a document first.');
        return;
    }
    
    const formData = new FormData();
    formData.append('document', selectedDocument);
    formData.append('target_style', document.getElementById('documentStyle').value);
    
    // Show progress
    const progressDiv = document.getElementById('documentProgress');
    const progressText = document.getElementById('documentProgressText');
    const btn = document.getElementById('generateFromDocBtn');
    
    progressDiv.classList.remove('d-none');
    progressText.textContent = 'Uploading and parsing document...';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.upload_document') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        progressText.textContent = 'Processing complete!';
        
        if (data.success) {
            // Fill in all the form fields
            document.getElementById('title').value = data.title || '';
            document.getElementById('content').value = data.content || '';
            document.getElementById('excerpt').value = data.excerpt || '';
            document.getElementById('meta_description').value = data.meta_description || '';
            document.getElementById('meta_keywords').value = data.meta_keywords || '';
            document.getElementById('category').value = data.category || '';
            document.getElementById('tags').value = data.tags || '';
            
            if (data.images && data.images.length > 0) {
                currentUnsplashImages = data.images;
                document.getElementById('og_image').value = data.images[0].url;
                showUnsplashGallery(data.images);
            }
            
            showNotification('Article generated successfully! Review and save your post.', 'success');
            
            // Scroll to the form
            document.getElementById('title').scrollIntoView({ behavior: 'smooth' });
        } else {
            showNotification(data.error || 'Failed to generate article', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        progressText.textContent = 'Error processing document';
        showNotification('Error processing document', 'danger');
    })
    .finally(() => {
        setTimeout(() => {
            progressDiv.classList.add('d-none');
            btn.disabled = false;
        }, 2000);
    });
}

function clearDocumentImport() {
    document.getElementById('documentUpload').value = '';
    selectedDocument = null;
    document.getElementById('generateFromDocBtn').disabled = true;
    document.getElementById('documentProgress').classList.add('d-none');
}

// ============================================================================
// PDF UPLOAD FUNCTIONS
// ============================================================================

let selectedPdf = null;

function handlePdfSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file type
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Please select a PDF file.');
            input.value = '';
            return;
        }
        
        // Validate file size (25MB max)
        if (file.size > 25 * 1024 * 1024) {
            alert('File is too large. Maximum size is 25MB.');
            input.value = '';
            return;
        }
        
        selectedPdf = file;
        document.getElementById('uploadPdfBtn').disabled = false;
    }
}

function uploadPdf() {
    if (!selectedPdf) {
        showNotification('Please select a PDF file first.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf', selectedPdf);
    
    // Include post_id if editing existing post
    {% if post %}
    formData.append('post_id', {{ post.id }});
    {% endif %}
    
    // Show progress
    const progressDiv = document.getElementById('pdfProgress');
    const progressText = document.getElementById('pdfProgressText');
    const btn = document.getElementById('uploadPdfBtn');
    
    progressDiv.classList.remove('d-none');
    progressText.textContent = 'Uploading PDF...';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.upload_pdf_api') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update hidden field and show info
            document.getElementById('pdfPath').value = data.pdf_path;
            
            // Hide upload section, show info
            document.getElementById('pdfUpload').value = '';
            document.getElementById('pdfFilename').textContent = data.filename;
            document.getElementById('pdfFileSize').textContent = formatFileSize(data.file_size);
            
            // Hide existing PDF info if present
            const existingInfo = document.getElementById('existingPdfInfo');
            if (existingInfo) {
                existingInfo.classList.add('d-none');
            }
            
            document.getElementById('pdfInfo').classList.remove('d-none');
            selectedPdf = null;
            document.getElementById('uploadPdfBtn').disabled = true;
            
            showNotification('PDF uploaded successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to upload PDF', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error uploading PDF', 'danger');
    })
    .finally(() => {
        progressDiv.classList.add('d-none');
        btn.disabled = false;
    });
}

function clearPdfUpload() {
    document.getElementById('pdfUpload').value = '';
    selectedPdf = null;
    document.getElementById('uploadPdfBtn').disabled = true;
    document.getElementById('pdfProgress').classList.add('d-none');
}

function deletePdf() {
    // Clear the hidden field and hide info
    document.getElementById('pdfPath').value = '';
    document.getElementById('pdfInfo').classList.add('d-none');
    selectedPdf = null;
    showNotification('PDF cleared. Click Save to remove it from the post.', 'info');
}

function deleteExistingPdf(postId) {
    if (!confirm('Are you sure you want to delete this PDF?')) {
        return;
    }
    
    fetch('{{ url_for('blog.delete_pdf_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ post_id: postId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide existing info and show upload section
            document.getElementById('existingPdfInfo').classList.add('d-none');
            document.getElementById('pdfPath').value = '';
            showNotification('PDF deleted successfully.', 'success');
        } else {
            showNotification(data.error || 'Failed to delete PDF', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting PDF', 'danger');
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Find analysis date by company name or ticker
function findAnalysisDate() {
    const searchTerm = document.getElementById('analysisSearchTerm').value.trim();
    
    if (!searchTerm || searchTerm.length < 2) {
        showNotification('Please enter at least 2 characters', 'warning');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.find_analysis_date_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ search_term: searchTerm })
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('analysisDateResults');
        
        if (data.success && data.analyses && data.analyses.length > 0) {
            let html = '<div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">';
            
            data.analyses.forEach((analysis, index) => {
                const tickerDisplay = analysis.ticker_symbol ? `(${analysis.ticker_symbol})` : '';
                const isSelected = index === 0 ? 'active' : '';
                
                html += `
                    <button type="button" class="list-group-item list-group-item-action ${isSelected} py-2" 
                            onclick="selectAnalysisDate('${analysis.analysis_date}', this)">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <strong class="small">${analysis.company_name}</strong>
                                <span class="text-muted small">${tickerDisplay}</span>
                                <div class="small text-muted">${analysis.formatted_date}</div>
                            </div>
                            <span class="badge bg-secondary small">${analysis.status}</span>
                        </div>
                    </button>
                `;
            });
            
            html += '</div>';
            html += `<div class="form-text small mt-1">Click an analysis to set its date. Found ${data.count} result(s).</div>`;
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('d-none');
            
            // Auto-select first result
            if (data.analyses[0].analysis_date) {
                const dateObj = new Date(data.analyses[0].analysis_date);
                const dateStr = dateObj.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
                document.getElementById('publish_date').value = dateStr;
            }
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning small py-2 mb-0">${data.message || 'No analyses found'}</div>`;
            resultsDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error searching analyses', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Select analysis date from results
function selectAnalysisDate(dateString, element) {
    if (!dateString) return;
    
    const dateObj = new Date(dateString);
    const dateStr = dateObj.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
    document.getElementById('publish_date').value = dateStr;
    
    // Update visual selection
    document.querySelectorAll('#analysisDateResults .list-group-item').forEach(el => {
        el.classList.remove('active');
    });
    element.classList.add('active');
    
    showNotification('Publish date updated!', 'success');
}

// ============================================================================
// TRANSLATION FUNCTIONS
// ============================================================================

function showTranslateModal() {
    const content = document.getElementById('content').value;
    if (!content.trim()) {
        showNotification('Please enter some content first.', 'warning');
        return;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('translateModal'));
    
    // Set content
    document.getElementById('translateContent').value = content;
    document.getElementById('translateContent').focus();
    updateCharCount();
    
    // Reset result area
    document.getElementById('translateResult').classList.add('d-none');
    document.getElementById('applyTranslateBtn').classList.add('d-none');
    document.getElementById('translateBtn').classList.remove('d-none');
    
    modal.show();
}

// Update character count
function updateCharCount() {
    const content = document.getElementById('translateContent').value;
    const count = content.length;
    document.getElementById('translateCharCount').textContent = `${count.toLocaleString()} / 10,000 characters`;
}

// Listen for content changes
document.addEventListener('DOMContentLoaded', function() {
    const translateContent = document.getElementById('translateContent');
    if (translateContent) {
        translateContent.addEventListener('input', updateCharCount);
    }
});

function performTranslation() {
    const content = document.getElementById('translateContent').value.trim();
    if (!content) {
        showNotification('Please enter content to translate.', 'warning');
        return;
    }
    
    if (content.length > 10000) {
        showNotification('Content is too long. Maximum 10,000 characters.', 'warning');
        return;
    }
    
    const sourceLang = document.getElementById('translateSourceLang').value;
    const targetLang = document.getElementById('translateTargetLang').value;
    
    if (sourceLang === targetLang) {
        showNotification('Source and target languages are the same.', 'warning');
        return;
    }
    
    // Show progress
    document.getElementById('translateProgress').classList.remove('d-none');
    document.getElementById('translateBtn').disabled = true;
    
    fetch('{{ url_for('blog.translate_content_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            text: content,
            source_lang: sourceLang,
            target_lang: targetLang
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('translateProgress').classList.add('d-none');
        document.getElementById('translateBtn').disabled = false;
        
        if (data.success) {
            document.getElementById('translatedContent').value = data.translated_text;
            document.getElementById('translateResult').classList.remove('d-none');
            document.getElementById('translateBtn').classList.add('d-none');
            document.getElementById('applyTranslateBtn').classList.remove('d-none');
            showNotification('Translation complete!', 'success');
        } else {
            showNotification(data.error || 'Translation failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('translateProgress').classList.add('d-none');
        document.getElementById('translateBtn').disabled = false;
        showNotification('Translation failed. Please try again.', 'danger');
    });
}

function applyTranslation() {
    const translatedContent = document.getElementById('translatedContent').value;
    if (translatedContent) {
        document.getElementById('content').value = translatedContent;
        showNotification('Translated content applied!', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('translateModal'));
        modal.hide();
    }
}

// Notification helper
function showNotification(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
