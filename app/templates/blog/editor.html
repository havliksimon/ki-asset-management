{% extends "blog/base_blog.html" %}

{% block title %}{% if post %}Edit: {{ post.title }}{% else %}New Research Article{% endif %} | KI Asset Management Research{% endblock %}

{% block content %}
<!-- Editor Header -->
<section class="blog-hero">
    <div class="container">
        <h1>{% if post %}Edit Research Article{% else %}New Research Article{% endif %}</h1>
        <p>Share your investment research and analysis with the KI Asset Management community.</p>
    </div>
</section>

<!-- AI Document Import Section (Only for new posts) -->
{% if not post %}
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-magic"></i> AI-Powered Document Import</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload a PDF or DOCX file (e.g., stock analysis, research paper) and let AI transform it into a complete, SEO-optimized blog article.
                </p>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Document File</label>
                        <input type="file" class="form-control" id="documentUpload" 
                               accept=".pdf,.docx,.doc" onchange="handleDocumentSelect(this)">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Target Style</label>
                        <select class="form-select" id="documentStyle">
                            <option value="seo_article">SEO Article</option>
                            <option value="investment_pitch">Investment Pitch (Stock Analysis)</option>
                            <option value="academic_paper">Academic Paper</option>
                            <option value="blog_post">Blog Post</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary w-100" id="generateFromDocBtn" 
                                onclick="generateFromDocument()" disabled>
                            <i class="bi bi-stars"></i> Generate Article
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearDocumentImport()">
                            <i class="bi bi-x-lg"></i> Clear
                        </button>
                    </div>
                </div>
                <div id="documentProgress" class="mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span id="documentProgressText">Processing document...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- PDF Research Files Section - Unified File Manager -->
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> Research Files (PDFs)</h5>
                <span class="badge bg-light text-success" id="pdfCountBadge">0 files</span>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload and manage all PDF files for your research. Drag to reorder - the first file will be the primary PDF 
                    shown to readers first. Perfect for research report + presentation combinations.
                </p>
                
                <!-- Upload New File -->
                <div class="mb-4 p-3 bg-light rounded border">
                    <label class="form-label fw-bold"><i class="bi bi-cloud-upload"></i> Upload New File</label>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-5">
                            <input type="file" class="form-control" id="pdfUpload" 
                                   accept=".pdf,.xlsx,.xls,.doc,.docx,.ppt,.pptx,.csv,.zip,.rar"
                                   onchange="handlePdfSelect(this)">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="pdfType">
                                <option value="research">Research Report (PDF)</option>
                                <option value="presentation">Presentation (PDF/PPT)</option>
                                <option value="model">Financial Model (Excel)</option>
                                <option value="supplemental">Supplemental (Any)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-success w-100" id="uploadPdfBtn" onclick="uploadPdf()" disabled>
                                <i class="bi bi-cloud-upload"></i> Upload File
                            </button>
                        </div>
                    </div>
                    <div class="form-text mt-2">
                        <strong>PDFs:</strong> Research reports, presentations | 
                        <strong>Excel:</strong> Financial models, data | 
                        <strong>Other:</strong> Word, PowerPoint, ZIP, etc.
                    </div>
                </div>
                
                <!-- Upload progress -->
                <div id="pdfProgress" class="mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                        <span id="pdfProgressText">Uploading...</span>
                    </div>
                </div>
                
                <!-- PDF Files List - Unified -->
                <div id="allPdfsContainer" class="mt-3">
                    <label class="form-label fw-bold"><i class="bi bi-list-ol"></i> PDF Files Order <small class="text-muted fw-normal">(Drag to reorder, first = primary)</small></label>
                    <div id="pdfList" class="list-group">
                        <!-- Files will be added here dynamically -->
                    </div>
                    <div id="noPdfsMessage" class="text-center py-4 text-muted">
                        <i class="bi bi-file-earmark-pdf display-4"></i>
                        <p class="mt-2">No PDFs uploaded yet. Upload your first research file above.</p>
                    </div>
                </div>
                
                <!-- AI Generate Title & SEO from PDFs Button -->
                <div id="generateFromPdfsSection" class="mt-4 p-3 bg-light rounded border" style="display: none;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-magic text-primary"></i> AI Title & SEO Generation</h6>
                            <p class="mb-0 text-muted small">Extracts company name from PDFs and generates: Title ("Company (TICKER) Stock Analysis - KI AM"), Meta Description, Keywords. <strong>Content is NOT generated - write your own notes below.</strong></p>
                        </div>
                        <button type="button" class="btn btn-primary" id="generateFromPdfsBtn" onclick="generateContentFromPdfs()">
                            <i class="bi bi-stars"></i> Generate Title & SEO
                        </button>
                    </div>
                    <div id="generateFromPdfsProgress" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span id="generateFromPdfsText">Analyzing PDFs and extracting company info...</span>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</section>

<div class="container mb-5">
    <form method="POST" action="{% if post %}{{ url_for('blog.edit_post', post_id=post.id) }}{% else %}{{ url_for('blog.new_post') }}{% endif %}" id="blogForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- Hidden fields for PDFs - these are updated by JavaScript when PDFs are uploaded -->
        <input type="hidden" name="pdf_path" id="pdfPath" value="{{ post.pdf_path if post and post.pdf_path else '' }}">
        <input type="hidden" name="additional_pdfs" id="additionalPdfsInput" value="">
        <script>
        // CSRF token helper - gets token from meta tag or hidden input
        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content ||
                   document.querySelector('input[name="csrf_token"]')?.value || '';
        }
        </script>
        
        <div class="row">
            <!-- Main Editor - Wide Column -->
            <div class="col-lg-9">
                <div class="blog-editor">
                    <div class="blog-editor-header">
                        <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Content</h5>
                    </div>
                    <div class="blog-editor-body">
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">Title *</label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                   value="{{ post.title if post else '' }}" required
                                   placeholder="Enter an engaging title...">
                            <div class="form-text">Make it catchy and descriptive. Max 255 characters.</div>
                        </div>
                        
                        <!-- Content - Analyst Notes Only -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">
                                Analyst Notes <span class="text-muted fw-normal">(Optional)</span>
                            </label>
                            <div class="form-text mb-2">
                                <i class="bi bi-info-circle"></i> Add any additional notes or commentary. The PDF research report is the main content. Leave empty if the PDF speaks for itself.
                            </div>
                            
                            <!-- Editor Toolbar - WordPress Style -->
                            <div class="editor-toolbar">
                                <!-- Text Formatting -->
                                <div class="editor-toolbar-group">
                                    <select id="headingSelect" onchange="insertHeading(this.value); this.value='';">
                                        <option value="">Paragraph</option>
                                        <option value="h2">Heading 2</option>
                                        <option value="h3">Heading 3</option>
                                        <option value="h4">Heading 4</option>
                                    </select>
                                </div>
                                
                                <!-- Basic Formatting -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" onclick="formatText('underline')" title="Underline (Ctrl+U)">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                    <button type="button" onclick="formatText('strikeThrough')" title="Strikethrough">
                                        <i class="bi bi-type-strikethrough"></i>
                                    </button>
                                </div>
                                
                                <!-- Alignment -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="formatText('justifyLeft')" title="Align Left">
                                        <i class="bi bi-text-left"></i>
                                    </button>
                                    <button type="button" onclick="formatText('justifyCenter')" title="Align Center">
                                        <i class="bi bi-text-center"></i>
                                    </button>
                                    <button type="button" onclick="formatText('justifyRight')" title="Align Right">
                                        <i class="bi bi-text-right"></i>
                                    </button>
                                </div>
                                
                                <!-- Lists -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                </div>
                                
                                <!-- Insert -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="insertLink()" title="Insert Link">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                    <button type="button" onclick="document.getElementById('imageUpload').click()" title="Insert Image">
                                        <i class="bi bi-image"></i>
                                    </button>
                                    <button type="button" onclick="insertBlock('blockquote')" title="Quote">
                                        <i class="bi bi-quote"></i>
                                    </button>
                                </div>
                                
                                <!-- Special Blocks -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="insertBlock('info')" title="Info Box">
                                        <i class="bi bi-info-circle text-primary"></i>
                                    </button>
                                    <button type="button" onclick="insertBlock('warning')" title="Warning Box">
                                        <i class="bi bi-exclamation-triangle text-warning"></i>
                                    </button>
                                    <button type="button" onclick="insertBlock('success')" title="Success Box">
                                        <i class="bi bi-check-circle text-success"></i>
                                    </button>
                                    <button type="button" onclick="insertBlock('danger')" title="Alert Box">
                                        <i class="bi bi-x-circle text-danger"></i>
                                    </button>
                                </div>
                                
                                <!-- Clear Formatting -->
                                <div class="editor-toolbar-group">
                                    <button type="button" onclick="formatText('removeFormat')" title="Clear Formatting">
                                        <i class="bi bi-eraser"></i>
                                    </button>
                                </div>
                                
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                            </div>
                            
                            <!-- Content Editor - Visual Mode (Default) -->
                            <div id="contentEditor" class="editor-content" contenteditable="true"
                                 oninput="updateTextareaFromDiv()"
                                 onblur="updateTextareaFromDiv()"
                                 style="display: block; min-height: 500px;">{{ post.content | safe if post else '' }}</div>
                            
                            <!-- HTML Editor - Hidden by default -->
                            <textarea id="content" name="content" class="form-control" 
                                      style="display: none; min-height: 500px; font-family: monospace;"
                                      rows="20">{{ post.content if post else '' }}</textarea>
                            
                            <div class="d-flex justify-content-between align-items-center mt-2 px-3">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Use toolbar for formatting. Supports rich text editing.
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleHtmlView()">
                                        <i class="bi bi-code-slash"></i> HTML
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showTranslateModal()">
                                        <i class="bi bi-translate"></i> Translate
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Excerpt -->
                        <div class="mb-4">
                            <label for="excerpt" class="form-label fw-bold">Excerpt</label>
                            <textarea class="form-control" id="excerpt" name="excerpt" rows="3"
                                      placeholder="Brief summary for previews (optional)...">{{ post.excerpt if post else '' }}</textarea>
                            <div class="form-text">A short summary that appears in previews. If left empty, we'll generate one from your content.</div>
                        </div>
                    </div>
                </div>
                
                <!-- SEO Settings -->
                <div class="blog-editor mt-4">
                    <div class="blog-editor-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-search"></i> SEO Settings</h5>
                            <small class="text-muted"><i class="bi bi-stars text-warning"></i> AI can auto-generate these from your PDF</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="autoGenerateSEO()">
                            <i class="bi bi-magic"></i> Auto-Generate with AI
                        </button>
                    </div>
                    <div class="blog-editor-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="meta_description" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="meta_description" name="meta_description" rows="3"
                                          placeholder="Description for search engines...">{{ post.meta_description if post else '' }}</textarea>
                                <div class="form-text">Max 300 characters. Shown in search results.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="meta_keywords" class="form-label">Meta Keywords</label>
                                <input type="text" class="form-control" id="meta_keywords" name="meta_keywords"
                                       value="{{ post.meta_keywords if post else '' }}"
                                       placeholder="investment, analysis, stocks...">
                                <div class="form-text">Comma-separated keywords.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="og_image" class="form-label">Featured Image URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="og_image" name="og_image"
                                       value="{{ post.og_image if post else '' }}"
                                       placeholder="https://example.com/image.jpg">
                                <button type="button" class="btn btn-outline-primary" onclick="searchUnsplashImage()">
                                    <i class="bi bi-image"></i> Auto-Find Image
                                </button>
                            </div>
                            <div class="form-text">URL to featured image for social sharing. Recommended: 1200x630px.</div>
                        </div>
                        
                        <!-- Manual Image Search -->
                        <div class="mb-3 p-3 bg-light rounded border">
                            <label class="form-label fw-bold"><i class="bi bi-search"></i> Manual Image Search</label>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="manualSearchQuery" 
                                           placeholder="Enter keywords (e.g., 'stock market', 'technology', 'office')...">
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchUnsplashManual()">
                                        <i class="bi bi-search"></i> Search Images
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                If auto-search doesn't find images, try searching with a single keyword like 
                                <code>business</code>, <code>technology</code>, <code>finance</code>, <code>charts</code>, 
                                <code>office</code>, or <code>city</code>.
                            </div>
                        </div>
                        
                        <div id="unsplashPreview" class="mt-3 d-none">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Choose a Featured Image:</label>
                                <span id="unsplashCount" class="badge bg-secondary"></span>
                            </div>
                            <div id="unsplashGallery" class="row g-2">
                                <!-- Images will be inserted here -->
                            </div>
                            <div id="unsplashNoResults" class="alert alert-warning d-none mt-3">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>No images found.</strong> Try searching with simpler keywords like 
                                <a href="javascript:void(0)" onclick="quickSearch('business')">business</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('technology')">technology</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('finance')">finance</a>, 
                                <a href="javascript:void(0)" onclick="quickSearch('office')">office</a>, or
                                <a href="javascript:void(0)" onclick="quickSearch('charts')">charts</a>.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Settings -->
            <div class="col-lg-3">
                <!-- Publish Settings -->
                <div class="blog-sidebar-card sticky-top" style="top: 100px;">
                    <h4><i class="bi bi-gear"></i> Post Settings</h4>
                    
                    <!-- Status -->
                    {% if post %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Status</label>
                        <div class="d-flex align-items-center gap-2">
                            {% if post.status == 'published' %}
                            <span class="status-badge published">
                                <i class="bi bi-check-circle"></i> Published
                            </span>
                            {% else %}
                            <span class="status-badge draft">
                                <i class="bi bi-pencil"></i> Draft
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Publish Date Editor (Admin or Published posts) -->
                        {% if current_user.is_admin or post.status == 'published' %}
                        <div class="mt-2">
                            <label for="publish_date" class="form-label small text-muted">Publish Date</label>
                            <input type="datetime-local" class="form-control form-control-sm" id="publish_date" name="publish_date"
                                   value="{{ post.published_at.strftime('%Y-%m-%dT%H:%M') if post.published_at else '' }}">
                            <div class="form-text small">Change when this post appears as published.</div>
                            
                            <!-- Auto-date tool based on analysis -->
                            <div class="mt-2 p-2 bg-light rounded">
                                <label class="form-label small text-muted">
                                    <i class="bi bi-calendar-check"></i> Auto-fill from Analysis
                                </label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="analysisSearchTerm" 
                                           placeholder="Enter company name or ticker...">
                                    <button type="button" class="btn btn-outline-secondary" onclick="findAnalysisDate()">
                                        <i class="bi bi-search"></i> Find
                                    </button>
                                </div>
                                <div class="form-text small">Search by company name/ticker to find analysis date.</div>
                                <div id="analysisDateResults" class="mt-2 d-none">
                                    <!-- Results will appear here -->
                                </div>
                            </div>
                        </div>
                        {% elif post.published_at %}
                        <div class="form-text mt-1">
                            Published: {{ post.published_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        {% else %}
                        <div class="form-text mt-1">
                            Not published yet
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label fw-bold">Category</label>
                        <input type="text" class="form-control" id="category" name="category"
                               value="{{ post.category if post else '' }}"
                               list="categoryList" placeholder="Select or type new...">
                        <datalist id="categoryList">
                            {% for category in categories %}
                            <option value="{{ category }}">
                            {% endfor %}
                            <option value="Market Analysis">
                            <option value="Investment Strategy">
                            <option value="Company Research">
                            <option value="Education">
                            <option value="News">
                        </datalist>
                    </div>
                    
                    <!-- Tags -->
                    <div class="mb-3">
                        <label for="tags" class="form-label fw-bold">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags"
                               value="{{ post.tags if post else '' }}"
                               placeholder="stocks, emerging-markets, value...">
                        <div class="form-text">Comma-separated tags.</div>
                    </div>
                    
                    <!-- Visibility / Publish Control -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_public" name="is_public" 
                                   {% if post %}{{ 'checked' if post.is_public else '' }}{% else %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="is_public">
                                <i class="bi bi-globe"></i> Public / Published
                            </label>
                        </div>
                        <div class="form-text">
                            {% if post and post.status == 'published' %}
                                This article is published and visible to everyone.
                            {% else %}
                                Check to publish and make visible to everyone. Uncheck to save as draft.
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Featured (Admin only) -->
                    {% if current_user.is_admin %}
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                                   {% if post %}{{ 'checked' if post.is_featured else '' }}{% endif %}>
                            <label class="form-check-label fw-bold" for="is_featured">
                                <i class="bi bi-star"></i> Featured Post
                            </label>
                        </div>
                        <div class="form-text">Show on homepage (Admin only).</div>
                    </div>
                    {% endif %}
                    
                    <!-- PDF Save Indicator -->
                    <div id="pdfSaveIndicator" class="alert alert-info mb-3" style="display: none;">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        <strong>PDF ready to save!</strong> This PDF will be attached to your article.
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" id="saveBtn">
                            <i class="bi bi-save"></i> 
                            <span id="saveBtnText">Save & Publish</span>
                        </button>
                        
                        {% if post %}
                        <a href="{{ url_for('blog.preview_post', post_id=post.id) }}?_embed=body" target="_blank" class="btn btn-outline-info" id="previewBtn">
                            <i class="bi bi-eye"></i> Preview
                        </a>
                        
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Back Link -->
                    <div class="mt-3 text-center">
                        <a href="{% if post %}{{ url_for('blog.post', slug=post.slug) }}{% else %}{{ url_for('blog.my_posts') }}{% endif %}" class="text-muted">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    {% if post %}
    <!-- Hidden form for unpublish action -->
    <form id="unpublishForm" action="{{ url_for('blog.unpublish_post', post_id=post.id) }}" method="POST" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
    {% endif %}
</div>

<!-- Delete Modal -->
{% if post %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong>{{ post.title }}</strong>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('blog.delete_post', post_id=post.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Yes, Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Translate Modal -->
<div class="modal fade" id="translateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-translate"></i> Translate Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Source Language</label>
                    <select class="form-select" id="translateSourceLang">
                        <option value="auto">Auto-detect</option>
                        <option value="cs" selected>Czech</option>
                        <option value="de">German</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="it">Italian</option>
                        <option value="pl">Polish</option>
                        <option value="sk">Slovak</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Target Language</label>
                    <select class="form-select" id="translateTargetLang">
                        <option value="en" selected>English</option>
                        <option value="cs">Czech</option>
                        <option value="de">German</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="it">Italian</option>
                        <option value="pl">Polish</option>
                        <option value="sk">Slovak</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Content to Translate</label>
                    <textarea class="form-control" id="translateContent" rows="8"
                              placeholder="Enter or paste content to translate..."></textarea>
                    <div class="form-text" id="translateCharCount">0 / 10,000 characters</div>
                </div>
                <div id="translateProgress" class="d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>Translating...</span>
                    </div>
                </div>
                <div id="translateResult" class="d-none">
                    <label class="form-label fw-bold">Translated Content</label>
                    <textarea class="form-control" id="translatedContent" rows="8"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="translateBtn" onclick="performTranslation()">
                    <i class="bi bi-translate"></i> Translate
                </button>
                <button type="button" class="btn btn-success d-none" id="applyTranslateBtn" onclick="applyTranslation()">
                    <i class="bi bi-check"></i> Apply to Content
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Custom column size for 5 columns on large screens */
.col-lg-1-5 {
    flex: 0 0 auto;
    width: 20%;
}

@media (max-width: 991.98px) {
    .col-lg-1-5 {
        width: 25%;
    }
}

@media (max-width: 767.98px) {
    .col-lg-1-5 {
        width: 33.333%;
    }
}

/* Image hover effect */
.unsplash-image-option {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.unsplash-image-option:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
}

/* Object fit for images */
.object-fit-cover {
    object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Insert HTML tags around selection
function insertTag(openTag, closeTag) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const before = text.substring(0, start);
    const selection = text.substring(start, end);
    const after = text.substring(end);
    
    textarea.value = before + openTag + selection + closeTag + after;
    textarea.focus();
    textarea.selectionStart = start + openTag.length;
    textarea.selectionEnd = end + openTag.length;
}

// Upload image
function uploadImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('{{ url_for('blog.upload_image') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.url) {
            const textarea = document.getElementById('content');
            const imgTag = `<img src="${data.url}" alt="${file.name}" class="img-fluid rounded">\n`;
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
            alert('Image uploaded and inserted!');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to upload image. Please try again.');
    });
}

// Auto-save draft (every 30 seconds)
{% if post %}
let autoSaveInterval;
let lastContent = document.getElementById('content').value;

document.addEventListener('DOMContentLoaded', function() {
    autoSaveInterval = setInterval(function() {
        const currentContent = document.getElementById('content').value;
        if (currentContent !== lastContent) {
            // Could implement auto-save to server here
            lastContent = currentContent;
            console.log('Auto-saved draft');
        }
    }, 30000);
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    const currentContent = document.getElementById('content').value;
    if (currentContent !== lastContent) {
        e.preventDefault();
        e.returnValue = '';
    }
});
{% endif %}

// Handle Public toggle changing Save button text
document.getElementById('is_public').addEventListener('change', function() {
    updateSaveButtonState(this.checked);
});

function updateSaveButtonState(isPublic) {
    const saveBtnText = document.getElementById('saveBtnText');
    const saveBtn = document.getElementById('saveBtn');
    
    if (!saveBtnText || !saveBtn) return;
    
    if (isPublic) {
        saveBtnText.textContent = 'Save & Publish';
        saveBtn.classList.remove('btn-primary', 'btn-warning');
        saveBtn.classList.add('btn-success');
    } else {
        saveBtnText.textContent = 'Save as Draft';
        saveBtn.classList.remove('btn-success', 'btn-warning');
        saveBtn.classList.add('btn-primary');
    }
}

// Initialize button state based on checkbox on page load
document.addEventListener('DOMContentLoaded', function() {
    const isPublicCheckbox = document.getElementById('is_public');
    if (isPublicCheckbox) {
        updateSaveButtonState(isPublicCheckbox.checked);
    }
    
    // Initialize contenteditable from textarea
    const contentEditor = document.getElementById('contentEditor');
    const contentTextarea = document.getElementById('content');
    if (contentEditor && contentTextarea && contentTextarea.value) {
        contentEditor.innerHTML = contentTextarea.value;
    }
});

// Content Editor Functions
function updateTextareaFromDiv() {
    const editor = document.getElementById('contentEditor');
    const textarea = document.getElementById('content');
    if (editor && textarea) {
        textarea.value = editor.innerHTML;
    }
}

function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('contentEditor').focus();
    updateTextareaFromDiv();
}

function insertHeading(tag) {
    if (!tag) return;
    formatText('formatBlock', tag);
}

function insertLink() {
    const url = prompt('Enter URL:', 'https://');
    if (url) {
        formatText('createLink', url);
    }
}

function insertBlock(type) {
    const editor = document.getElementById('contentEditor');
    let blockHtml = '';
    
    switch(type) {
        case 'blockquote':
            blockHtml = '<blockquote style="border-left: 4px solid #1a9c5e; padding-left: 1rem; margin: 1rem 0; font-style: italic; color: #4b5563;"><p>Enter your quote here...</p></blockquote>';
            break;
        case 'info':
            blockHtml = '<div class="editor-block editor-block-info" style="border-left: 4px solid #3b82f6; background: #eff6ff; padding: 1rem; margin: 1rem 0; border-radius: 0.375rem;"><strong style="color: #1e40af;"><i class="bi bi-info-circle"></i> Info:</strong> <span>Your information here...</span></div>';
            break;
        case 'warning':
            blockHtml = '<div class="editor-block editor-block-warning" style="border-left: 4px solid #f59e0b; background: #fffbeb; padding: 1rem; margin: 1rem 0; border-radius: 0.375rem;"><strong style="color: #92400e;"><i class="bi bi-exclamation-triangle"></i> Warning:</strong> <span>Your warning here...</span></div>';
            break;
        case 'success':
            blockHtml = '<div class="editor-block editor-block-success" style="border-left: 4px solid #10b981; background: #ecfdf5; padding: 1rem; margin: 1rem 0; border-radius: 0.375rem;"><strong style="color: #065f46;"><i class="bi bi-check-circle"></i> Success:</strong> <span>Your success message here...</span></div>';
            break;
        case 'danger':
            blockHtml = '<div class="editor-block editor-block-danger" style="border-left: 4px solid #ef4444; background: #fef2f2; padding: 1rem; margin: 1rem 0; border-radius: 0.375rem;"><strong style="color: #991b1b;"><i class="bi bi-x-circle"></i> Important:</strong> <span>Your alert here...</span></div>';
            break;
    }
    
    if (blockHtml) {
        document.execCommand('insertHTML', false, blockHtml);
        updateTextareaFromDiv();
    }
}

let htmlViewMode = false;
function toggleHtmlView() {
    const editor = document.getElementById('contentEditor');
    const textarea = document.getElementById('content');
    const btn = event.target.closest('button');
    
    if (!htmlViewMode) {
        // Switch to HTML view
        textarea.value = editor.innerHTML; // Copy content from visual editor
        textarea.style.display = 'block';
        editor.style.display = 'none';
        if (btn) {
            btn.innerHTML = '<i class="bi bi-eye"></i> Visual';
            btn.classList.add('active');
        }
        htmlViewMode = true;
    } else {
        // Switch to visual view
        editor.innerHTML = textarea.value; // Copy content from HTML editor
        textarea.style.display = 'none';
        editor.style.display = 'block';
        if (btn) {
            btn.innerHTML = '<i class="bi bi-code-slash"></i> HTML';
            btn.classList.remove('active');
        }
        htmlViewMode = false;
    }
}

// Form validation
document.getElementById('blogForm').addEventListener('submit', function(e) {
    // Update textarea from contenteditable before validation
    updateTextareaFromDiv();
    
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const pdfPath = document.getElementById('pdfPath').value.trim();
    
    if (!title) {
        e.preventDefault();
        alert('Please enter a title.');
        document.getElementById('title').focus();
        return false;
    }
    
    // Either content or PDF is required
    if (!content && !pdfPath) {
        e.preventDefault();
        alert('Please enter some content or upload a PDF file.');
        document.getElementById('contentEditor').focus();
        return false;
    }
    
    return true;
});

// ============================================================================
// AI-ASSISTED FUNCTIONS
// ============================================================================

// Store current images for selection
let currentUnsplashImages = [];

// Auto-generate SEO metadata using DeepSeek AI
function autoGenerateSEO() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const category = document.getElementById('category').value.trim();
    
    if (!title || !content) {
        alert('Please enter a title and content first.');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.generate_seo_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ title, content, category })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fill in the SEO fields
            if (data.meta_description) {
                document.getElementById('meta_description').value = data.meta_description;
            }
            if (data.meta_keywords) {
                document.getElementById('meta_keywords').value = data.meta_keywords;
            }
            if (data.excerpt && !document.getElementById('excerpt').value) {
                document.getElementById('excerpt').value = data.excerpt;
            }
            if (data.suggested_tags && !document.getElementById('tags').value) {
                document.getElementById('tags').value = data.suggested_tags;
            }
            if (data.images && data.images.length > 0) {
                currentUnsplashImages = data.images;
                document.getElementById('og_image').value = data.images[0].url;
                showUnsplashGallery(data.images);
                document.getElementById('unsplashNoResults').classList.add('d-none');
            } else {
                // Show no results message with suggestions
                const previewDiv = document.getElementById('unsplashPreview');
                const gallery = document.getElementById('unsplashGallery');
                const noResultsDiv = document.getElementById('unsplashNoResults');
                const countBadge = document.getElementById('unsplashCount');
                
                gallery.innerHTML = '';
                countBadge.textContent = '0 images';
                noResultsDiv.classList.remove('d-none');
                previewDiv.classList.remove('d-none');
            }
            
            // Show success notification
            showNotification('SEO metadata generated successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to generate SEO', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error generating SEO metadata', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Search for Unsplash images (auto mode - based on title/category)
function searchUnsplashImage() {
    const title = document.getElementById('title').value.trim();
    const category = document.getElementById('category').value.trim();
    
    // Build search query from title/category
    let query = category || '';
    if (title) {
        // Extract key words from title (words longer than 4 chars)
        const words = title.match(/\b[A-Za-z]{5,}\b/g) || [];
        if (words.length > 0) {
            query = words.slice(0, 3).join(' ');
        }
    }
    
    if (!query) {
        showNotification('Please enter a title or category first, or use manual search below.', 'warning');
        document.getElementById('manualSearchQuery').focus();
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Searching...';
    btn.disabled = true;
    
    // Request up to 30 images
    performUnsplashSearch(query, 30, btn, originalText, true);
}

// Manual search for Unsplash images
function searchUnsplashManual() {
    const query = document.getElementById('manualSearchQuery').value.trim();
    
    if (!query) {
        showNotification('Please enter search keywords.', 'warning');
        document.getElementById('manualSearchQuery').focus();
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Searching...';
    btn.disabled = true;
    
    // Request up to 30 images
    performUnsplashSearch(query, 30, btn, originalText, false);
}

// Quick search from "no results" message links
function quickSearch(keyword) {
    document.getElementById('manualSearchQuery').value = keyword;
    
    // Find the manual search button and trigger click
    const btn = document.querySelector('button[onclick="searchUnsplashManual()"]');
    if (btn) {
        btn.click();
    }
}

// Perform the actual Unsplash API search
function performUnsplashSearch(query, count, btn, originalText, isAutoSearch) {
    fetch('{{ url_for('blog.search_unsplash_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ query, orientation: 'landscape', count: count })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.images && data.images.length > 0) {
            currentUnsplashImages = data.images;
            document.getElementById('og_image').value = data.images[0].url;
            showUnsplashGallery(data.images);
            
            // Hide "no results" message
            document.getElementById('unsplashNoResults').classList.add('d-none');
            
            const searchType = isAutoSearch ? 'Auto-search' : 'Search';
            showNotification(`${searchType} found ${data.images.length} images! Click one to select.`, 'success');
        } else {
            // Show gallery area but with "no results" message
            const previewDiv = document.getElementById('unsplashPreview');
            const gallery = document.getElementById('unsplashGallery');
            const noResultsDiv = document.getElementById('unsplashNoResults');
            const countBadge = document.getElementById('unsplashCount');
            
            gallery.innerHTML = '';
            countBadge.textContent = '0 images';
            noResultsDiv.classList.remove('d-none');
            previewDiv.classList.remove('d-none');
            
            if (isAutoSearch) {
                showNotification(`No images found for "${data.query || query}". Try manual search with simpler keywords.`, 'warning');
            } else {
                showNotification(`No images found for "${data.query || query}". Try different keywords.`, 'warning');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error searching for images', 'danger');
    })
    .finally(() => {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}

// Show Unsplash image gallery
function showUnsplashGallery(images) {
    const previewDiv = document.getElementById('unsplashPreview');
    const gallery = document.getElementById('unsplashGallery');
    const countBadge = document.getElementById('unsplashCount');
    
    gallery.innerHTML = '';
    
    // Update count badge
    countBadge.textContent = `${images.length} image${images.length !== 1 ? 's' : ''}`;
    
    images.forEach((image, index) => {
        const col = document.createElement('div');
        // Adjust column size based on image count - more images = smaller columns
        let colClass = 'col-4 col-md-2';
        if (images.length > 12) {
            colClass = 'col-3 col-md-2 col-lg-1-5';  // Smaller for many images
        }
        col.className = colClass;
        col.innerHTML = `
            <div class="unsplash-image-option position-relative cursor-pointer rounded overflow-hidden ${index === 0 ? 'border border-3 border-primary' : 'border'}" 
                 onclick="selectUnsplashImage(${index}, this)" 
                 style="cursor: pointer; aspect-ratio: 16/10;"
                 title="${image.description || 'Image by ' + image.author_name}">
                <img src="${image.thumb_url || image.url}" 
                     alt="${image.description || 'Unsplash image'}" 
                     class="w-100 h-100 object-fit-cover"
                     loading="lazy">
                <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-1" style="font-size: 0.6rem;">
                    by ${image.author_name}
                </div>
            </div>
        `;
        gallery.appendChild(col);
    });
    
    previewDiv.classList.remove('d-none');
}

// Select a specific Unsplash image
function selectUnsplashImage(index, element) {
    if (!currentUnsplashImages[index]) return;
    
    // Update selected image
    document.getElementById('og_image').value = currentUnsplashImages[index].url;
    
    // Update visual selection
    document.querySelectorAll('.unsplash-image-option').forEach(el => {
        el.classList.remove('border-3', 'border-primary');
        el.classList.add('border');
    });
    element.classList.remove('border');
    element.classList.add('border-3', 'border-primary');
    
    showNotification('Image selected!', 'success');
}

// Document upload handling
let selectedDocument = null;

function handleDocumentSelect(input) {
    if (input.files && input.files[0]) {
        selectedDocument = input.files[0];
        document.getElementById('generateFromDocBtn').disabled = false;
        
        // Validate file size (max 10MB)
        if (selectedDocument.size > 10 * 1024 * 1024) {
            alert('File is too large. Maximum size is 10MB.');
            clearDocumentImport();
            return;
        }
    }
}

function generateFromDocument() {
    if (!selectedDocument) {
        alert('Please select a document first.');
        return;
    }
    
    const formData = new FormData();
    formData.append('document', selectedDocument);
    formData.append('target_style', document.getElementById('documentStyle').value);
    
    // Show progress
    const progressDiv = document.getElementById('documentProgress');
    const progressText = document.getElementById('documentProgressText');
    const btn = document.getElementById('generateFromDocBtn');
    
    progressDiv.classList.remove('d-none');
    progressText.textContent = 'Uploading and parsing document...';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.upload_document') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        progressText.textContent = 'Processing complete!';
        
        if (data.success) {
            // Fill in all the form fields
            document.getElementById('title').value = data.title || '';
            document.getElementById('content').value = data.content || '';
            document.getElementById('excerpt').value = data.excerpt || '';
            document.getElementById('meta_description').value = data.meta_description || '';
            document.getElementById('meta_keywords').value = data.meta_keywords || '';
            document.getElementById('category').value = data.category || '';
            document.getElementById('tags').value = data.tags || '';
            
            if (data.images && data.images.length > 0) {
                currentUnsplashImages = data.images;
                document.getElementById('og_image').value = data.images[0].url;
                showUnsplashGallery(data.images);
            }
            
            showNotification('Article generated successfully! Review and save your post.', 'success');
            
            // Scroll to the form
            document.getElementById('title').scrollIntoView({ behavior: 'smooth' });
        } else {
            showNotification(data.error || 'Failed to generate article', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        progressText.textContent = 'Error processing document';
        showNotification('Error processing document', 'danger');
    })
    .finally(() => {
        setTimeout(() => {
            progressDiv.classList.add('d-none');
            btn.disabled = false;
        }, 2000);
    });
}

function clearDocumentImport() {
    document.getElementById('documentUpload').value = '';
    selectedDocument = null;
    document.getElementById('generateFromDocBtn').disabled = true;
    document.getElementById('documentProgress').classList.add('d-none');
}

// ============================================================================
// PDF UPLOAD FUNCTIONS
// ============================================================================

let selectedPdf = null;

function handlePdfSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file type - allow PDFs and common document formats
        const allowedExtensions = ['pdf', 'xlsx', 'xls', 'docx', 'doc', 'pptx', 'ppt', 'csv', 'zip', 'rar', 'txt', 'json', 'xml'];
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(ext)) {
            alert('File type not allowed. Allowed: PDF, Excel, Word, PowerPoint, CSV, ZIP, TXT');
            input.value = '';
            return;
        }
        
        // Validate file size (25MB max)
        if (file.size > 25 * 1024 * 1024) {
            alert('File is too large. Maximum size is 25MB.');
            input.value = '';
            return;
        }
        
        selectedPdf = file;
        document.getElementById('uploadPdfBtn').disabled = false;
    }
}

function uploadPdf() {
    if (!selectedPdf) {
        showNotification('Please select a PDF file first.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf', selectedPdf);
    
    // Check if AI SEO generation is enabled
    const generateSeoCheckbox = document.getElementById('generateSeoFromPdf');
    formData.append('generate_seo', generateSeoCheckbox && generateSeoCheckbox.checked ? 'true' : 'false');
    
    {% if post %}
    formData.append('post_id', {{ post.id }});
    {% endif %}
    
    const progressDiv = document.getElementById('pdfProgress');
    const progressText = document.getElementById('pdfProgressText');
    const btn = document.getElementById('uploadPdfBtn');
    
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressText) progressText.textContent = generateSeoCheckbox && generateSeoCheckbox.checked ? 'Uploading PDF & generating AI SEO...' : 'Uploading PDF...';
    if (btn) btn.disabled = true;
    
    fetch('{{ url_for('blog.upload_pdf_api') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(function(response) {
        // Check for redirects (login required) or non-JSON responses
        if (response.redirected || response.status === 401 || !response.headers.get('content-type')?.includes('application/json')) {
            showNotification('Your session may have expired. Please log in again.', 'warning');
            return { error: 'Session expired' };
        }
        return response.json();
    })
    .then(function(data) {
        console.log('Upload response:', data);
        if (data.success) {
            console.log('Setting pdfPath to:', data.pdf_path);
            const pdfPathEl = document.getElementById('pdfPath');
            const pdfUploadEl = document.getElementById('pdfUpload');
            const pdfFilenameEl = document.getElementById('pdfFilename');
            const pdfFileSizeEl = document.getElementById('pdfFileSize');
            const existingInfo = document.getElementById('existingPdfInfo');
            const pdfInfoEl = document.getElementById('pdfInfo');
            const uploadPdfBtnEl = document.getElementById('uploadPdfBtn');
            
            // Set the hidden pdf_path field
            if (pdfPathEl) {
                pdfPathEl.value = data.pdf_path || '';
                console.log('pdfPath value after set:', pdfPathEl.value);
            }
            
            // Clear the file input
            if (pdfUploadEl) pdfUploadEl.value = '';
            
            // Display filename and size
            if (pdfFilenameEl) pdfFilenameEl.textContent = data.filename || 'Unknown';
            if (pdfFileSizeEl) pdfFileSizeEl.textContent = data.file_size ? formatFileSize(data.file_size) : '';
            
            // Hide existing PDF info if present
            if (existingInfo) {
                existingInfo.style.display = 'none';
            }
            
            // Show the PDF info card
            if (pdfInfoEl) {
                pdfInfoEl.style.display = 'block';
                // Scroll to the PDF info
                pdfInfoEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Show the PDF save indicator
            const pdfSaveIndicator = document.getElementById('pdfSaveIndicator');
            if (pdfSaveIndicator) {
                pdfSaveIndicator.style.display = 'block';
            }
            
            // Highlight the save button
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.classList.add('btn-success');
                saveBtn.classList.remove('btn-primary');
                saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Draft (with PDF)';
            }
            
            // Auto-fill title if empty and we have a suggested title
            const titleEl = document.getElementById('title');
            if (titleEl && !titleEl.value.trim() && data.suggested_title) {
                titleEl.value = data.suggested_title;
                showNotification('Title auto-filled from PDF: ' + data.suggested_title, 'info');
            }
            
            // Auto-fill category if ticker is detected from filename
            if (data.ticker) {
                const categoryEl = document.getElementById('category');
                if (categoryEl && !categoryEl.value.trim()) {
                    categoryEl.value = 'Stock Analysis';
                }
                // Add ticker to tags if not already present
                const tagsEl = document.getElementById('tags');
                if (tagsEl && !tagsEl.value.includes(data.ticker)) {
                    if (tagsEl.value.trim()) {
                        tagsEl.value = data.ticker + ', ' + tagsEl.value;
                    } else {
                        tagsEl.value = data.ticker;
                    }
                }
                showNotification('Detected ticker: ' + data.ticker + '. Category set to "Stock Analysis".', 'info');
            }
            
            // Auto-fill SEO fields if AI generated them
            let seoFieldsFilled = false;
            const filledFields = [];
            
            if (data.meta_description) {
                const metaDescEl = document.getElementById('meta_description');
                if (metaDescEl && !metaDescEl.value.trim()) {
                    metaDescEl.value = data.meta_description;
                    seoFieldsFilled = true;
                    filledFields.push('Meta Description');
                }
            }
            
            if (data.meta_keywords) {
                const metaKeywordsEl = document.getElementById('meta_keywords');
                if (metaKeywordsEl && !metaKeywordsEl.value.trim()) {
                    metaKeywordsEl.value = data.meta_keywords;
                    seoFieldsFilled = true;
                    filledFields.push('Keywords');
                }
            }
            
            if (data.excerpt) {
                const excerptEl = document.getElementById('excerpt');
                if (excerptEl && !excerptEl.value.trim()) {
                    excerptEl.value = data.excerpt;
                    seoFieldsFilled = true;
                    filledFields.push('Excerpt');
                }
            }
            
            if (data.suggested_tags) {
                const tagsEl = document.getElementById('tags');
                if (tagsEl && !tagsEl.value.trim()) {
                    tagsEl.value = data.suggested_tags;
                    seoFieldsFilled = true;
                    filledFields.push('Tags');
                }
            }
            
            // Scroll to SEO section if fields were filled
            if (seoFieldsFilled) {
                const seoSection = document.querySelector('.blog-editor:nth-of-type(2)');
                if (seoSection) {
                    seoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            selectedPdf = null;
            if (uploadPdfBtnEl) uploadPdfBtnEl.disabled = true;
            
            // Build notification message
            let notificationMsg = 'PDF uploaded successfully!';
            if (seoFieldsFilled) {
                notificationMsg += ' AI generated: ' + filledFields.join(', ') + '.';
            }
            notificationMsg += ' Click "Save Draft (with PDF)" to save everything.';
            
            showNotification(notificationMsg, 'success');
        } else {
            showNotification(data.error || 'Failed to upload PDF', 'danger');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('Error uploading PDF: ' + (error.message || 'Unknown error'), 'danger');
    })
    .finally(function() {
        if (progressDiv) progressDiv.style.display = 'none';
        if (btn) btn.disabled = false;
    });
}

function clearPdfUpload() {
    const pdfUpload = document.getElementById('pdfUpload');
    const uploadBtn = document.getElementById('uploadPdfBtn');
    const pdfProgress = document.getElementById('pdfProgress');
    
    if (pdfUpload) pdfUpload.value = '';
    selectedPdf = null;
    if (uploadBtn) uploadBtn.disabled = true;
    if (pdfProgress) pdfProgress.style.display = 'none';
}

// ============================================================================
// UNIFIED PDF MANAGER (All Files with Reordering)
// ============================================================================

let allPdfs = []; // Array of all PDFs, first one is primary
let draggedItem = null;

// File type configuration with icons for different file types
const fileTypeConfig = {
    'research': { label: 'Research', badge: 'bg-success', icon: 'bi-file-earmark-pdf' },
    'presentation': { label: 'Presentation', badge: 'bg-primary', icon: 'bi-easel' },
    'model': { label: 'Financial Model', badge: 'bg-info', icon: 'bi-calculator' },
    'supplemental': { label: 'Supplemental', badge: 'bg-secondary', icon: 'bi-file-earmark' }
};

// Get file icon based on extension
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'pdf': 'bi-file-earmark-pdf text-danger',
        'xlsx': 'bi-file-earmark-excel text-success',
        'xls': 'bi-file-earmark-excel text-success',
        'csv': 'bi-file-earmark-spreadsheet text-success',
        'docx': 'bi-file-earmark-word text-primary',
        'doc': 'bi-file-earmark-word text-primary',
        'pptx': 'bi-file-earmark-ppt text-warning',
        'ppt': 'bi-file-earmark-ppt text-warning',
        'zip': 'bi-file-earmark-zip text-secondary',
        'rar': 'bi-file-earmark-zip text-secondary'
    };
    return iconMap[ext] || 'bi-file-earmark text-secondary';
}

// Check if file is viewable (PDF)
function isViewableFile(filename) {
    return filename.toLowerCase().endsWith('.pdf');
}

function addPdfToList(pdfData) {
    allPdfs.push(pdfData);
    renderPdfList();
    updatePdfInputs();
}

function removePdf(index) {
    allPdfs.splice(index, 1);
    renderPdfList();
    updatePdfInputs();
}

function movePdf(index, direction) {
    if (direction === 'up' && index > 0) {
        [allPdfs[index], allPdfs[index - 1]] = [allPdfs[index - 1], allPdfs[index]];
    } else if (direction === 'down' && index < allPdfs.length - 1) {
        [allPdfs[index], allPdfs[index + 1]] = [allPdfs[index + 1], allPdfs[index]];
    }
    renderPdfList();
    updatePdfInputs();
}

function setPrimary(index) {
    if (index > 0 && index < allPdfs.length) {
        const pdf = allPdfs.splice(index, 1)[0];
        allPdfs.unshift(pdf);
        renderPdfList();
        updatePdfInputs();
        showNotification('Primary PDF updated', 'success');
    }
}

function renderPdfList() {
    const container = document.getElementById('pdfList');
    const noMessage = document.getElementById('noPdfsMessage');
    const badge = document.getElementById('pdfCountBadge');
    const generateSection = document.getElementById('generateFromPdfsSection');
    
    if (!container) return;
    
    // Update badge
    if (badge) {
        badge.textContent = allPdfs.length + ' file' + (allPdfs.length !== 1 ? 's' : '');
    }
    
    // Show/hide no message
    if (noMessage) {
        noMessage.style.display = allPdfs.length === 0 ? 'block' : 'none';
    }
    
    // Show/hide generate from PDFs button
    if (generateSection) {
        generateSection.style.display = allPdfs.length > 0 ? 'block' : 'none';
    }
    
    container.innerHTML = '';
    
    allPdfs.forEach((pdf, index) => {
        const config = fileTypeConfig[pdf.file_type] || fileTypeConfig['supplemental'];
        const isPrimary = index === 0;
        const isPdf = isViewableFile(pdf.filename);
        const fileIcon = getFileIcon(pdf.filename);
        
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex align-items-center gap-3 p-3';
        item.draggable = true;
        item.dataset.index = index;
        
        // Drag handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'cursor-move text-muted';
        dragHandle.innerHTML = '<i class="bi bi-grip-vertical fs-5"></i>';
        dragHandle.style.cursor = 'move';
        
        // File info
        const fileInfo = document.createElement('div');
        fileInfo.className = 'flex-grow-1';
        fileInfo.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                ${isPrimary ? '<span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> PRIMARY</span>' : `<span class="badge ${config.badge}">${config.label}</span>`}
                <i class="bi ${fileIcon}"></i>
                <strong>${pdf.filename}</strong>
                ${pdf.description ? `<small class="text-muted">- ${pdf.description}</small>` : ''}
                <small class="text-muted">(${formatFileSize(pdf.file_size)})</small>
            </div>
            ${isPrimary ? `<div class="text-success small mt-1"><i class="bi bi-${isPdf ? 'eye' : 'download'}"></i> This ${isPdf ? 'PDF' : 'file'} will be shown first to readers</div>` : ''}
        `;
        
        // Actions
        const actions = document.createElement('div');
        actions.className = 'btn-group btn-group-sm';
        
        if (!isPrimary) {
            actions.innerHTML += `
                <button type="button" class="btn btn-outline-warning" onclick="setPrimary(${index})" title="Set as Primary">
                    <i class="bi bi-star"></i>
                </button>
            `;
        }
        
        if (index > 0) {
            actions.innerHTML += `
                <button type="button" class="btn btn-outline-secondary" onclick="movePdf(${index}, 'up')" title="Move Up">
                    <i class="bi bi-arrow-up"></i>
                </button>
            `;
        }
        
        if (index < allPdfs.length - 1) {
            actions.innerHTML += `
                <button type="button" class="btn btn-outline-secondary" onclick="movePdf(${index}, 'down')" title="Move Down">
                    <i class="bi bi-arrow-down"></i>
                </button>
            `;
        }
        
        // View button for PDFs, Download button for other files
        if (isPdf) {
            actions.innerHTML += `
                <a href="${pdf.path.startsWith('http') ? pdf.path : '/static/' + pdf.path}" target="_blank" class="btn btn-outline-primary" title="View PDF">
                    <i class="bi bi-eye"></i>
                </a>
            `;
        } else {
            actions.innerHTML += `
                <a href="${pdf.path.startsWith('http') ? pdf.path : '/static/' + pdf.path}" download class="btn btn-outline-success" title="Download File">
                    <i class="bi bi-download"></i>
                </a>
            `;
        }
        
        actions.innerHTML += `
            <button type="button" class="btn btn-outline-danger" onclick="removePdf(${index})" title="Remove">
                <i class="bi bi-trash"></i>
            </button>
        `;
        
        item.appendChild(dragHandle);
        item.appendChild(fileInfo);
        item.appendChild(actions);
        
        // Drag and drop events
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.style.opacity = '0.5';
        });
        
        item.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            draggedItem = null;
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedItem !== this) {
                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(this.dataset.index);
                
                // Swap items
                const [moved] = allPdfs.splice(fromIndex, 1);
                allPdfs.splice(toIndex, 0, moved);
                
                renderPdfList();
                updatePdfInputs();
            }
        });
        
        container.appendChild(item);
    });
}

function updatePdfInputs() {
    const pdfPathInput = document.getElementById('pdfPath');
    const additionalPdfsInput = document.getElementById('additionalPdfsInput');
    
    if (allPdfs.length > 0) {
        // First PDF is the primary one
        if (pdfPathInput) {
            pdfPathInput.value = allPdfs[0].path;
        }
        // Rest are additional
        if (additionalPdfsInput) {
            additionalPdfsInput.value = JSON.stringify(allPdfs.slice(1));
        }
    } else {
        if (pdfPathInput) pdfPathInput.value = '';
        if (additionalPdfsInput) additionalPdfsInput.value = '';
    }
}

// Upload PDF without AI generation (AI happens after all PDFs are uploaded)
function uploadPdf() {
    if (!selectedPdf) {
        showNotification('Please select a PDF file first.', 'warning');
        return;
    }
    
    const fileType = document.getElementById('pdfType').value;
    
    const formData = new FormData();
    formData.append('pdf', selectedPdf);
    formData.append('file_type', fileType);
    formData.append('generate_seo', 'false'); // No AI during upload
    
    {% if post %}
    formData.append('post_id', {{ post.id }});
    {% endif %}
    
    const progressDiv = document.getElementById('pdfProgress');
    const progressText = document.getElementById('pdfProgressText');
    const btn = document.getElementById('uploadPdfBtn');
    
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressText) progressText.textContent = 'Uploading PDF...';
    if (btn) btn.disabled = true;
    
    fetch('{{ url_for('blog.upload_pdf_api') }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to unified list
            addPdfToList({
                path: data.pdf_path,
                filename: data.filename,
                file_type: fileType,
                description: '',
                file_size: data.file_size
            });
            
            // Clear inputs
            document.getElementById('pdfUpload').value = '';
            selectedPdf = null;
            document.getElementById('uploadPdfBtn').disabled = true;
            
            // Auto-fill title from filename if empty
            const titleEl = document.getElementById('title');
            if (titleEl && !titleEl.value.trim() && data.suggested_title) {
                titleEl.value = data.suggested_title;
            }
            
            // Auto-set category if ticker detected
            if (data.ticker) {
                const categoryEl = document.getElementById('category');
                if (categoryEl && !categoryEl.value.trim()) {
                    categoryEl.value = 'Stock Analysis';
                }
                const tagsEl = document.getElementById('tags');
                if (tagsEl && !tagsEl.value.includes(data.ticker)) {
                    tagsEl.value = data.ticker + (tagsEl.value ? ', ' + tagsEl.value : '');
                }
            }
            
            showNotification('PDF uploaded! Click "Generate from PDFs" to create content from all PDFs.', 'success');
        } else {
            showNotification(data.error || 'Failed to upload PDF', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error uploading PDF', 'danger');
    })
    .finally(() => {
        if (progressDiv) progressDiv.style.display = 'none';
        if (btn) btn.disabled = false;
    });
}

// Generate title and SEO from all uploaded PDFs (NO content generation - analyst writes content manually)
function generateContentFromPdfs() {
    if (allPdfs.length === 0) {
        showNotification('Please upload at least one PDF first.', 'warning');
        return;
    }
    
    const btn = document.getElementById('generateFromPdfsBtn');
    const progressDiv = document.getElementById('generateFromPdfsProgress');
    const progressText = document.getElementById('generateFromPdfsText');
    
    if (btn) btn.disabled = true;
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressText) progressText.textContent = 'Analyzing PDFs and generating SEO data...';
    
    // Get all PDF paths
    const pdfPaths = allPdfs.map(pdf => pdf.path);
    
    fetch('{{ url_for('blog.generate_from_pdfs_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ pdf_paths: pdfPaths })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fill in TITLE (always from PDF analysis, not filename)
            if (data.title) {
                document.getElementById('title').value = data.title;
            }
            
            // Fill in SEO fields if not already set
            if (data.meta_description && !document.getElementById('meta_description').value.trim()) {
                document.getElementById('meta_description').value = data.meta_description;
            }
            if (data.meta_keywords && !document.getElementById('meta_keywords').value.trim()) {
                document.getElementById('meta_keywords').value = data.meta_keywords;
            }
            if (data.suggested_tags && !document.getElementById('tags').value.trim()) {
                document.getElementById('tags').value = data.suggested_tags;
            }
            
            // DO NOT fill content - analyst writes manually
            // DO NOT fill excerpt - leave empty or analyst writes
            
            showNotification('Title and SEO generated! Content field left empty for your manual notes.', 'success');
        } else {
            showNotification(data.error || 'Failed to generate SEO data', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error generating SEO from PDFs', 'danger');
    })
    .finally(() => {
        if (btn) btn.disabled = false;
        if (progressDiv) progressDiv.style.display = 'none';
    });
}

// Load existing PDFs when editing
{% if post %}
document.addEventListener('DOMContentLoaded', function() {
    // Load primary PDF
    {% if post.pdf_path %}
    allPdfs.push({
        path: {{ post.pdf_path | tojson }},
        filename: {{ post.pdf_filename | tojson }},
        file_type: 'research',
        description: '',
        file_size: 0
    });
    {% endif %}
    
    // Load additional PDFs
    {% if post.additional_pdfs %}
    try {
        const additional = {{ post.additional_pdfs | tojson | safe }};
        if (Array.isArray(additional)) {
            additional.forEach(pdf => {
                allPdfs.push({
                    path: pdf.path,
                    filename: pdf.filename,
                    file_type: pdf.file_type || 'supplemental',
                    description: pdf.description || '',
                    file_size: pdf.file_size || 0
                });
            });
        }
    } catch(e) {
        console.error('Error loading additional PDFs:', e);
    }
    {% endif %}
    
    renderPdfList();
    updatePdfInputs();
});
{% endif %}

function deletePdf() {
    // Clear the hidden field and hide info
    const pdfPathEl = document.getElementById('pdfPath');
    const pdfInfoEl = document.getElementById('pdfInfo');
    const pdfUploadEl = document.getElementById('pdfUpload');
    const pdfSaveIndicator = document.getElementById('pdfSaveIndicator');
    const saveBtn = document.getElementById('saveBtn');
    
    if (pdfPathEl) {
        pdfPathEl.value = '';
        console.log('pdfPath cleared');
    }
    if (pdfInfoEl) {
        pdfInfoEl.style.display = 'none';
    }
    if (pdfUploadEl) {
        pdfUploadEl.value = '';
    }
    
    // Hide the PDF save indicator
    if (pdfSaveIndicator) {
        pdfSaveIndicator.style.display = 'none';
    }
    
    // Reset the save button
    if (saveBtn) {
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-primary');
        saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Draft';
    }
    
    selectedPdf = null;
    showNotification('PDF removed. Click "Save Draft" to save changes.', 'info');
}

function deleteExistingPdf(postId) {
    if (!confirm('Are you sure you want to delete this PDF?')) {
        return;
    }
    
    fetch('{{ url_for('blog.delete_pdf_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ post_id: postId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const existingPdfInfo = document.getElementById('existingPdfInfo');
            const pdfPathEl = document.getElementById('pdfPath');
            const pdfSaveIndicator = document.getElementById('pdfSaveIndicator');
            
            if (existingPdfInfo) existingPdfInfo.style.display = 'none';
            if (pdfPathEl) pdfPathEl.value = '';
            if (pdfSaveIndicator) pdfSaveIndicator.style.display = 'none';
            showNotification('PDF deleted. Click "Save Draft" to save changes.', 'success');
        } else {
            showNotification(data.error || 'Failed to delete PDF', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting PDF', 'danger');
    });
}

// Stub for deleting attachments (not implemented yet)
function deleteAttachment(attachmentId) {
    alert('Delete attachment not implemented yet. Please save the post without the attachment.');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Find analysis date by company name or ticker
function findAnalysisDate() {
    const searchTerm = document.getElementById('analysisSearchTerm').value.trim();
    
    if (!searchTerm || searchTerm.length < 2) {
        showNotification('Please enter at least 2 characters', 'warning');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    fetch('{{ url_for('blog.find_analysis_date_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ search_term: searchTerm })
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('analysisDateResults');
        
        if (data.success && data.analyses && data.analyses.length > 0) {
            let html = '<div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">';
            
            data.analyses.forEach((analysis, index) => {
                const tickerDisplay = analysis.ticker_symbol ? `(${analysis.ticker_symbol})` : '';
                const isSelected = index === 0 ? 'active' : '';
                
                html += `
                    <button type="button" class="list-group-item list-group-item-action ${isSelected} py-2" 
                            onclick="selectAnalysisDate('${analysis.analysis_date}', this)">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <strong class="small">${analysis.company_name}</strong>
                                <span class="text-muted small">${tickerDisplay}</span>
                                <div class="small text-muted">${analysis.formatted_date}</div>
                            </div>
                            <span class="badge bg-secondary small">${analysis.status}</span>
                        </div>
                    </button>
                `;
            });
            
            html += '</div>';
            html += `<div class="form-text small mt-1">Click an analysis to set its date. Found ${data.count} result(s).</div>`;
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('d-none');
            
            // Auto-select first result
            if (data.analyses[0].analysis_date) {
                const dateObj = new Date(data.analyses[0].analysis_date);
                const dateStr = dateObj.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
                document.getElementById('publish_date').value = dateStr;
            }
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning small py-2 mb-0">${data.message || 'No analyses found'}</div>`;
            resultsDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error searching analyses', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Select analysis date from results
function selectAnalysisDate(dateString, element) {
    if (!dateString) return;
    
    const dateObj = new Date(dateString);
    const dateStr = dateObj.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
    document.getElementById('publish_date').value = dateStr;
    
    // Update visual selection
    document.querySelectorAll('#analysisDateResults .list-group-item').forEach(el => {
        el.classList.remove('active');
    });
    element.classList.add('active');
    
    showNotification('Publish date updated!', 'success');
}

// ============================================================================
// TRANSLATION FUNCTIONS
// ============================================================================

function showTranslateModal() {
    const content = document.getElementById('content').value;
    if (!content.trim()) {
        showNotification('Please enter some content first.', 'warning');
        return;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('translateModal'));
    
    // Set content
    document.getElementById('translateContent').value = content;
    document.getElementById('translateContent').focus();
    updateCharCount();
    
    // Reset result area
    document.getElementById('translateResult').classList.add('d-none');
    document.getElementById('applyTranslateBtn').classList.add('d-none');
    document.getElementById('translateBtn').classList.remove('d-none');
    
    modal.show();
}

// Update character count
function updateCharCount() {
    const content = document.getElementById('translateContent').value;
    const count = content.length;
    document.getElementById('translateCharCount').textContent = `${count.toLocaleString()} / 10,000 characters`;
}

// Listen for content changes
document.addEventListener('DOMContentLoaded', function() {
    const translateContent = document.getElementById('translateContent');
    if (translateContent) {
        translateContent.addEventListener('input', updateCharCount);
    }
});

function performTranslation() {
    const content = document.getElementById('translateContent').value.trim();
    if (!content) {
        showNotification('Please enter content to translate.', 'warning');
        return;
    }
    
    if (content.length > 10000) {
        showNotification('Content is too long. Maximum 10,000 characters.', 'warning');
        return;
    }
    
    const sourceLang = document.getElementById('translateSourceLang').value;
    const targetLang = document.getElementById('translateTargetLang').value;
    
    if (sourceLang === targetLang) {
        showNotification('Source and target languages are the same.', 'warning');
        return;
    }
    
    // Show progress
    document.getElementById('translateProgress').classList.remove('d-none');
    document.getElementById('translateBtn').disabled = true;
    
    fetch('{{ url_for('blog.translate_content_api') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            text: content,
            source_lang: sourceLang,
            target_lang: targetLang
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('translateProgress').classList.add('d-none');
        document.getElementById('translateBtn').disabled = false;
        
        if (data.success) {
            document.getElementById('translatedContent').value = data.translated_text;
            document.getElementById('translateResult').classList.remove('d-none');
            document.getElementById('translateBtn').classList.add('d-none');
            document.getElementById('applyTranslateBtn').classList.remove('d-none');
            showNotification('Translation complete!', 'success');
        } else {
            showNotification(data.error || 'Translation failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('translateProgress').classList.add('d-none');
        document.getElementById('translateBtn').disabled = false;
        showNotification('Translation failed. Please try again.', 'danger');
    });
}

function applyTranslation() {
    const translatedContent = document.getElementById('translatedContent').value;
    if (translatedContent) {
        document.getElementById('content').value = translatedContent;
        showNotification('Translated content applied!', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('translateModal'));
        modal.hide();
    }
}

// Notification helper
function showNotification(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
